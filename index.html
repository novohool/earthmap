<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js è°·æ­Œåœ°çƒæ¨¡æ‹Ÿå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a192f, #172a45);
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 10, 30, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(100, 150, 255, 0.2);
            z-index: 10;
        }
        
        .title {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .search-container {
            display: flex;
            width: 400px;
            gap: 10px;
        }
        
        .search-box {
            flex: 1;
            padding: 12px 18px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            border: 1px solid rgba(100, 150, 255, 0.3);
        }
        
        .search-box:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.5);
        }
        
        .search-btn {
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 242, 254, 0.2);
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 242, 254, 0.3);
        }
        
        #earth-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 10, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            width: 300px;
            border: 1px solid rgba(100, 150, 255, 0.2);
            z-index: 5;
        }
        
        .panel-title {
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(100, 150, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4facfe;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .control-btn {
            padding: 12px;
            border-radius: 10px;
            background: rgba(79, 172, 254, 0.1);
            border: 1px solid rgba(79, 172, 254, 0.3);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .control-btn:hover {
            background: rgba(79, 172, 254, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.2);
        }
        
        .control-btn i {
            font-size: 20px;
            color: #00f2fe;
        }
        
        .locations {
            margin-top: 15px;
        }
        
        .location-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .location-item {
            padding: 10px 15px;
            border-radius: 8px;
            background: rgba(79, 172, 254, 0.05);
            border: 1px solid rgba(79, 172, 254, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .location-item:hover {
            background: rgba(79, 172, 254, 0.15);
            transform: translateX(5px);
        }
        
        .location-item i {
            color: #00f2fe;
        }
        
        .info-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(0, 10, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            width: 280px;
            border: 1px solid rgba(100, 150, 255, 0.2);
            transform: translateY(0);
            transition: transform 0.4s ease;
            z-index: 5;
        }
        
        .info-panel.hidden {
            transform: translateY(-150%);
        }
        
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            color: #00f2fe;
        }
        
        .city-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #4facfe;
        }
        
        .country {
            color: #00f2fe;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .stat {
            background: rgba(79, 172, 254, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #00f2fe;
        }
        
        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .time-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 10, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 8px 20px;
            font-size: 18px;
            font-weight: 600;
            border: 1px solid rgba(100, 150, 255, 0.2);
            z-index: 5;
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 10, 30, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(79, 172, 254, 0.1);
            border-top: 5px solid #00f2fe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            letter-spacing: 1px;
            color: #4facfe;
        }
        
        .progress-bar {
            width: 300px;
            height: 6px;
            background: rgba(79, 172, 254, 0.1);
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .attribution {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 10, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 12px;
            border: 1px solid rgba(100, 150, 255, 0.2);
            z-index: 5;
        }
        
        .attribution a {
            color: #00f2fe;
            text-decoration: none;
        }
        
        .attribution a:hover {
            text-decoration: underline;
        }
        
        .texture-info {
            position: absolute;
            bottom: 60px;
            right: 20px;
            background: rgba(0, 10, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 12px;
            border: 1px solid rgba(100, 150, 255, 0.2);
            z-index: 5;
        }
        
        .weather-info {
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .weather-stat {
            background: rgba(79, 172, 254, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        .weather-stat .stat-value {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #00f2fe;
        }
        
        .weather-stat .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 1rem;
            }
            
            .title {
                font-size: 1.5rem;
            }
            
            .search-container {
                width: 100%;
            }
            
            .control-panel {
                width: calc(100% - 40px);
            }
            
            .info-panel {
                width: calc(100% - 40px);
                top: 80px;
                right: 20px;
                left: 20px;
            }
            
            .texture-info {
                bottom: 100px;
                right: 20px;
                left: 20px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">Three.js è°·æ­Œåœ°çƒæ¨¡æ‹Ÿå™¨</div>
        <div class="search-container">
            <input type="text" class="search-box" placeholder="æœç´¢åŸå¸‚æˆ–åæ ‡..." id="search-input">
            <button class="search-btn" id="search-btn">æœç´¢</button>
        </div>
    </div>
    
    <div id="earth-container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">åŠ è½½é«˜åˆ†è¾¨ç‡çº¹ç†ä¸­...</div>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>
        
        <div class="time-display" id="time-display">ä¸–ç•Œæ—¶: 12:00 PM</div>
        
        <div class="control-panel">
            <div class="panel-title">ğŸŒ åœ°çƒæ§åˆ¶é¢æ¿</div>
            <div class="controls">
                <button class="control-btn" id="reset-view">
                    <i>ğŸ”„</i>
                    <span>é‡ç½®è§†å›¾</span>
                </button>
                <button class="control-btn" id="toggle-atmosphere">
                    <i>ğŸŒ¤ï¸</i>
                    <span>å¤§æ°”æ•ˆæœ</span>
                </button>
                <button class="control-btn" id="toggle-lights">
                    <i>ğŸ’¡</i>
                    <span>å¤œé—´ç¯å…‰</span>
                </button>
                <button class="control-btn" id="toggle-rotation">
                    <i>â±ï¸</i>
                    <span>æ—‹è½¬åœ°çƒ</span>
                </button>
                <button class="control-btn" id="toggle-daynight">
                    <i>ğŸŒ</i>
                    <span>æ˜¼å¤œå¾ªç¯</span>
                </button>
            </div>
            
            <div class="locations">
                <div class="panel-title">ğŸ“ çƒ­é—¨åœ°ç‚¹</div>
                <div class="location-list">
                    <div class="location-item" data-location="tokyo">
                        <i>ğŸ—¼</i>
                        <span>ä¸œäº¬, æ—¥æœ¬</span>
                    </div>
                    <div class="location-item" data-location="paris">
                        <i>ğŸ—¼</i>
                        <span>å·´é», æ³•å›½</span>
                    </div>
                    <div class="location-item" data-location="newyork">
                        <i>ğŸ—½</i>
                        <span>çº½çº¦, ç¾å›½</span>
                    </div>
                    <div class="location-item" data-location="sydney">
                        <i>âš“</i>
                        <span>æ‚‰å°¼, æ¾³å¤§åˆ©äºš</span>
                    </div>
                    <div class="location-item" data-location="london">
                        <i>ğŸ°</i>
                        <span>ä¼¦æ•¦, è‹±å›½</span>
                    </div>
                    <div class="location-item" data-location="shanghai">
                        <i>ğŸŒ†</i>
                        <span>ä¸Šæµ·, ä¸­å›½</span>
                    </div>
                    <div class="location-item" data-location="dubai">
                        <i>ğŸ™ï¸</i>
                        <span>è¿ªæ‹œ, é˜¿è”é…‹</span>
                    </div>
                    <div class="location-item" data-location="beijing">
                        <i>ğŸ›ï¸</i>
                        <span>åŒ—äº¬, ä¸­å›½</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-panel hidden" id="info-panel">
            <div class="info-header">
                <div>
                    <div class="city-name" id="info-city">åŸå¸‚åç§°</div>
                    <div class="country" id="info-country">å›½å®¶</div>
                </div>
                <button class="close-btn" id="close-info">âœ•</button>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="info-population">8.3M</div>
                    <div class="stat-label">äººå£</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="info-time">10:30 AM</div>
                    <div class="stat-label">å½“åœ°æ—¶é—´</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="info-temp">22Â°C</div>
                    <div class="stat-label">æ¸©åº¦</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="info-elevation">40m</div>
                    <div class="stat-label">æµ·æ‹”</div>
                </div>
            </div>
            <div class="weather-info">
                <div class="weather-stat">
                    <div class="stat-value" id="info-weather">æ™´æœ—</div>
                    <div class="stat-label">å¤©æ°”çŠ¶å†µ</div>
                </div>
                <div class="weather-stat">
                    <div class="stat-value" id="info-humidity">65%</div>
                    <div class="stat-label">æ¹¿åº¦</div>
                </div>
                <div class="weather-stat">
                    <div class="stat-value" id="info-wind">ä¸œåŒ—é£ 3çº§</div>
                    <div class="stat-label">é£åŠ›</div>
                </div>
            </div>
        </div>
        
        <div class="texture-info">
            çº¹ç†æ¥æº: Three.jså®˜æ–¹ç¤ºä¾‹ - 4096x4096é«˜åˆ†è¾¨ç‡
        </div>
        
        <div class="attribution">
            åŸºäº <a href="https://threejs.org" target="_blank">Three.js</a> | é«˜åˆ†è¾¨ç‡åœ°çƒçº¹ç†
        </div>
    </div>

    <script>
        // ä¸»è¦å˜é‡
        let scene, camera, renderer, earth, atmosphere, cloudLayer;
        let controls, stars;
        let earthRotationEnabled = true;
        let atmosphereEnabled = true;
        let cityLightsEnabled = true;
        let marker;
        let texturesLoaded = 0;
        let totalTextures = 4;
        let sunLight;
        let sunMesh;
        let dayNightCycle = true;
        let dayNightSpeed = 0.01;
        let sunAngle = 0;
        
        // çº¹ç†URL
        const textureUrls = {
            day: 'https://threejs.org/examples/textures/planets/earth_day_4096.jpg',
            night: 'https://threejs.org/examples/textures/planets/earth_night_4096.jpg',
            specular: 'https://threejs.org/examples/textures/planets/earth_specular_2048.jpg',
            clouds: 'https://threejs.org/examples/textures/planets/earth_clouds_1024.png'
        };
        
        // çº¹ç†å¯¹è±¡
        const textures = {
            day: null,
            night: null,
            specular: null,
            clouds: null
        };
        
        // åŸå¸‚æ•°æ®
        const cityData = {
            tokyo: { 
                lat: 35.6895, 
                lon: 139.6917, 
                name: "ä¸œäº¬", 
                country: "æ—¥æœ¬", 
                population: "37.4M", 
                elevation: "40m",
                temp: "22Â°C",
                weather: "æ™´æœ—",
                humidity: "65%",
                wind: "ä¸œåŒ—é£ 3çº§"
            },
            paris: { 
                lat: 48.8566, 
                lon: 2.3522, 
                name: "å·´é»", 
                country: "æ³•å›½", 
                population: "11.0M", 
                elevation: "35m",
                temp: "18Â°C",
                weather: "å¤šäº‘",
                humidity: "70%",
                wind: "è¥¿é£ 2çº§"
            },
            newyork: { 
                lat: 40.7128, 
                lon: -74.0060, 
                name: "çº½çº¦", 
                country: "ç¾å›½", 
                population: "20.1M", 
                elevation: "10m",
                temp: "25Â°C",
                weather: "æ™´æœ—",
                humidity: "60%",
                wind: "å—é£ 4çº§"
            },
            sydney: { 
                lat: -33.8688, 
                lon: 151.2093, 
                name: "æ‚‰å°¼", 
                country: "æ¾³å¤§åˆ©äºš", 
                population: "5.3M", 
                elevation: "58m",
                temp: "20Â°C",
                weather: "æ™´æœ—",
                humidity: "55%",
                wind: "ä¸œå—é£ 3çº§"
            },
            beijing: { 
                lat: 39.9042, 
                lon: 116.4074, 
                name: "åŒ—äº¬", 
                country: "ä¸­å›½", 
                population: "21.5M", 
                elevation: "44m",
                temp: "26Â°C",
                weather: "æ™´æœ—",
                humidity: "45%",
                wind: "åŒ—é£ 2çº§"
            },
            london: {
                lat: 51.5074,
                lon: -0.1278,
                name: "ä¼¦æ•¦",
                country: "è‹±å›½",
                population: "8.9M",
                elevation: "35m",
                temp: "16Â°C",
                weather: "å°é›¨",
                humidity: "75%",
                wind: "è¥¿é£ 3çº§"
            },
            shanghai: {
                lat: 31.2304,
                lon: 121.4737,
                name: "ä¸Šæµ·",
                country: "ä¸­å›½",
                population: "24.2M",
                elevation: "4m",
                temp: "28Â°C",
                weather: "å¤šäº‘",
                humidity: "70%",
                wind: "ä¸œé£ 2çº§"
            },
            dubai: {
                lat: 25.2048,
                lon: 55.2708,
                name: "è¿ªæ‹œ",
                country: "é˜¿è”é…‹",
                population: "3.3M",
                elevation: "0m",
                temp: "35Â°C",
                weather: "æ™´æœ—",
                humidity: "40%",
                wind: "è¥¿åŒ—é£ 2çº§"
            }
        };
        
        // åˆå§‹åŒ–åœºæ™¯
        function init() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000022);
            
            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(
                45, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                1000
            );
            camera.position.z = 300;
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('earth-container').appendChild(renderer.domElement);
            
            // æ·»åŠ è½¨é“æ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 150;
            controls.maxDistance = 500;
            controls.target.set(0, 0, 0);
            
            // æ·»åŠ å…‰æº
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambientLight);
            
            const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
            sunLight.position.set(300, 0, 0); // åˆå§‹ä½ç½®åœ¨å³ä¾§ï¼ˆä¸œæ–¹ï¼‰
            scene.add(sunLight);
            
            // åˆ›å»ºæ˜Ÿç©ºèƒŒæ™¯
            createStarBackground();
            
            // åŠ è½½çº¹ç†
            loadTextures();
        }
        
        // åŠ è½½çº¹ç†
        function loadTextures() {
            const textureLoader = new THREE.TextureLoader();
            
            // åŠ è½½æ—¥é—´çº¹ç†
            textureLoader.load(textureUrls.day, (texture) => {
                textures.day = texture;
                textureLoaded();
            });
            
            // åŠ è½½å¤œé—´çº¹ç†
            textureLoader.load(textureUrls.night, (texture) => {
                textures.night = texture;
                textureLoaded();
            });
            
            // åŠ è½½é•œé¢åå°„çº¹ç†
            textureLoader.load(textureUrls.specular, (texture) => {
                textures.specular = texture;
                textureLoaded();
            });
            
            // åŠ è½½äº‘å±‚çº¹ç†
            textureLoader.load(textureUrls.clouds, (texture) => {
                textures.clouds = texture;
                textureLoaded();
            });
        }
        
        // çº¹ç†åŠ è½½å®Œæˆå›è°ƒ
        function textureLoaded() {
            texturesLoaded++;
            const progress = Math.floor((texturesLoaded / totalTextures) * 100);
            document.getElementById('progress').style.width = `${progress}%`;
            
            if (texturesLoaded === totalTextures) {
                // æ‰€æœ‰çº¹ç†åŠ è½½å®Œæˆï¼Œåˆ›å»ºåœ°çƒ
                createEarth();
                
                // å¼€å§‹åŠ¨ç”»
                animate();
                
                // éšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    document.getElementById('loading').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                    }, 500);
                }, 500);
                
                // åˆå§‹è§†å›¾æŒ‡å‘ä¸œäº¬ï¼Œä½†ä¸æ”¹å˜åœ°çƒä½ç½®
                setTimeout(() => {
                    viewCity('tokyo');
                }, 1000);
            }
        }
        
        // åˆ›å»ºæ˜Ÿç©ºèƒŒæ™¯
        function createStarBackground() {
            // åˆ›å»ºä¸¤ç§æ˜Ÿæ˜Ÿï¼šäº®æ˜Ÿå’Œæš—æ˜Ÿ
            createStarLayer('bright', 5000, 1.5, 0.9, 0xffffff);
            createStarLayer('dim', 10000, 0.8, 0.6, 0xaaaaaa);
        }

        // åˆ›å»ºæ˜Ÿæ˜Ÿå±‚
        function createStarLayer(type, count, size, opacity, color) {
            const starGeometry = new THREE.BufferGeometry();
            const starMaterial = new THREE.PointsMaterial({
                color: color,
                size: size,
                sizeAttenuation: true,
                transparent: true,
                opacity: opacity,
                blending: THREE.AdditiveBlending
            });

            const starVertices = [];
            const starColors = [];
            const starSizes = [];
            const starSpeeds = [];
            const starPhases = [];

            // ä½¿ç”¨çƒé¢åˆ†å¸ƒåˆ›å»ºæ›´è‡ªç„¶çš„æ˜Ÿç©ºæ•ˆæœ
            for (let i = 0; i < count; i++) {
                // ä½¿ç”¨å¤šå±‚çƒé¢åˆ†å¸ƒï¼Œå¢åŠ åŠå¾„èŒƒå›´
                const radius = 500 + Math.random() * 1000; // å¢åŠ æ˜Ÿæ˜Ÿçš„åˆ†å¸ƒèŒƒå›´
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);

                const x = radius * Math.sin(phi) * Math.cos(theta);
                const y = radius * Math.sin(phi) * Math.sin(theta);
                const z = radius * Math.cos(phi);

                starVertices.push(x, y, z);

                // éšæœºæ˜Ÿæ˜Ÿé¢œè‰²
                const starColor = new THREE.Color(color);
                if (type === 'bright') {
                    // äº®æ˜Ÿå¯ä»¥æœ‰è½»å¾®çš„é¢œè‰²å˜åŒ–
                    const hue = Math.random() > 0.7 ? 0.6 : 0.1; // åè“æˆ–åé»„
                    starColor.setHSL(hue, 0.8, 0.8 + Math.random() * 0.2);
                }
                starColors.push(starColor.r, starColor.g, starColor.b);

                // éšæœºæ˜Ÿæ˜Ÿå¤§å°
                const baseSize = size * (0.8 + Math.random() * 0.4);
                starSizes.push(baseSize);

                // éšæœºé—ªçƒé€Ÿåº¦
                starSpeeds.push(0.3 + Math.random() * 0.7);

                // éšæœºåˆå§‹ç›¸ä½
                starPhases.push(Math.random() * Math.PI * 2);
            }

            // è®¾ç½®å‡ ä½•ä½“å±æ€§
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));
            starGeometry.setAttribute('size', new THREE.Float32BufferAttribute(starSizes, 1));
            starGeometry.setAttribute('speed', new THREE.Float32BufferAttribute(starSpeeds, 1));
            starGeometry.setAttribute('phase', new THREE.Float32BufferAttribute(starPhases, 1));

            // åˆ›å»ºæ˜Ÿæ˜Ÿç‚¹äº‘
            const starLayer = new THREE.Points(starGeometry, starMaterial);
            starLayer.userData = {
                type: type,
                initialSizes: starSizes.slice(),
                rotationSpeed: type === 'bright' ? 0.0001 : 0.00005
            };
            scene.add(starLayer);

            // å­˜å‚¨æ˜Ÿæ˜Ÿå±‚å¼•ç”¨
            if (!stars) stars = [];
            stars.push(starLayer);
        }
        
        // åˆ›å»ºåœ°çƒ
        function createEarth() {
            // åœ°çƒå‡ ä½•ä½“
            const earthGeometry = new THREE.SphereGeometry(100, 128, 128);
            
            // åˆ›å»ºåœ°çƒç€è‰²å™¨æè´¨
            const earthMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    dayTexture: { value: textures.day },
                    nightTexture: { value: textures.night },
                    sunPosition: { value: new THREE.Vector3(0, 0, 0) },
                    specularMap: { value: textures.specular },
                    specularColor: { value: new THREE.Color(0x333333) },
                    shininess: { value: 10.0 }
                },
                vertexShader: `
                    varying vec2 vUv;
                    varying vec3 vNormal;
                    varying vec3 vPosition;
                    
                    void main() {
                        vUv = uv;
                        vNormal = normalize(normalMatrix * normal);
                        vPosition = position;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform sampler2D dayTexture;
                    uniform sampler2D nightTexture;
                    uniform sampler2D specularMap;
                    uniform vec3 sunPosition;
                    uniform vec3 specularColor;
                    uniform float shininess;
                    
                    varying vec2 vUv;
                    varying vec3 vNormal;
                    varying vec3 vPosition;
                    
                    void main() {
                        // è®¡ç®—å¤ªé˜³æ–¹å‘
                        vec3 sunDir = normalize(sunPosition);
                        
                        // è®¡ç®—å…‰ç…§å¼ºåº¦
                        float lightIntensity = max(0.0, dot(vNormal, sunDir));
                        
                        // è¯»å–çº¹ç†
                        vec4 dayColor = texture2D(dayTexture, vUv);
                        vec4 nightColor = texture2D(nightTexture, vUv);
                        vec4 specular = texture2D(specularMap, vUv);
                        
                        // è®¡ç®—é•œé¢åå°„
                        vec3 viewDir = normalize(-vPosition);
                        vec3 reflectDir = reflect(-sunDir, vNormal);
                        float spec = pow(max(dot(viewDir, reflectDir), 0.0), shininess);
                        vec3 specularHighlight = specularColor * spec * specular.r;
                        
                        // æ··åˆæ—¥å¤œçº¹ç†
                        vec4 finalColor = mix(nightColor, dayColor, lightIntensity);
                        
                        // æ·»åŠ é•œé¢åå°„
                        finalColor.rgb += specularHighlight;
                        
                        gl_FragColor = finalColor;
                    }
                `,
                transparent: true
            });
            
            // åœ°çƒç½‘æ ¼
            earth = new THREE.Mesh(earthGeometry, earthMaterial);
            earth.position.set(0, 0, 0);
            earth.renderOrder = 1;
            scene.add(earth);
            
            // åˆ›å»ºäº‘å±‚
            const cloudGeometry = new THREE.SphereGeometry(101, 128, 128);
            const cloudMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    cloudTexture: { value: textures.clouds },
                    sunPosition: { value: new THREE.Vector3(0, 0, 0) }
                },
                vertexShader: `
                    varying vec2 vUv;
                    varying vec3 vNormal;
                    
                    void main() {
                        vUv = uv;
                        vNormal = normalize(normalMatrix * normal);
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform sampler2D cloudTexture;
                    uniform vec3 sunPosition;
                    
                    varying vec2 vUv;
                    varying vec3 vNormal;
                    
                    void main() {
                        // è®¡ç®—å¤ªé˜³æ–¹å‘
                        vec3 sunDir = normalize(sunPosition);
                        
                        // è®¡ç®—å…‰ç…§å¼ºåº¦
                        float lightIntensity = max(0.0, dot(vNormal, sunDir));
                        
                        // è¯»å–äº‘å±‚çº¹ç†
                        vec4 cloudColor = texture2D(cloudTexture, vUv);
                        
                        // åªåœ¨ç™½å¤©æ˜¾ç¤ºäº‘å±‚
                        float cloudOpacity = cloudColor.a * lightIntensity;
                        
                        gl_FragColor = vec4(cloudColor.rgb, cloudOpacity * 0.8);
                    }
                `,
                transparent: true,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });
            
            cloudLayer = new THREE.Mesh(cloudGeometry, cloudMaterial);
            cloudLayer.renderOrder = 2;
            scene.add(cloudLayer);
            
            // åˆ›å»ºå¤§æ°”å±‚
            createAtmosphere();
            
            // åˆ›å»ºå¤ªé˜³
            createSun();
            
            // æ·»åŠ åŸå¸‚æ ‡è®°
            addCityMarkers();
        }
        
        // åˆ›å»ºå¤§æ°”å±‚
        function createAtmosphere() {
            const atmosphereGeometry = new THREE.SphereGeometry(103, 128, 128);
            
            // åˆ›å»ºå¤§æ°”å±‚ç€è‰²å™¨æè´¨
            const atmosphereMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    sunPosition: { value: new THREE.Vector3(0, 0, 0) },
                    atmosphereColor: { value: new THREE.Color(0x5599dd) },
                    glowColor: { value: new THREE.Color(0x00aaff) }
                },
                vertexShader: `
                    varying vec3 vNormal;
                    varying vec3 vPosition;
                    void main() {
                        vNormal = normalize(normalMatrix * normal);
                        vPosition = position;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform vec3 sunPosition;
                    uniform vec3 atmosphereColor;
                    uniform vec3 glowColor;
                    varying vec3 vNormal;
                    varying vec3 vPosition;
                    
                    void main() {
                        float intensity = pow(0.7 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 2.0);
                        vec3 atmosphere = atmosphereColor * intensity;
                        
                        // æ·»åŠ å¤ªé˜³å…‰æ•£å°„
                        float sunIntensity = pow(max(0.0, dot(vNormal, normalize(sunPosition))), 32.0);
                        vec3 sunGlow = glowColor * sunIntensity;
                        
                        gl_FragColor = vec4(atmosphere + sunGlow, intensity * 0.3);
                    }
                `,
                transparent: true,
                side: THREE.BackSide,
                blending: THREE.AdditiveBlending
            });
            
            atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
            scene.add(atmosphere);
        }
        
        // åˆ›å»ºå¤ªé˜³
        function createSun() {
            // åˆ›å»ºå¤ªé˜³å…‰æº
            sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
            sunLight.position.set(300, 0, 0); // åˆå§‹ä½ç½®åœ¨å³ä¾§ï¼ˆä¸œæ–¹ï¼‰
            scene.add(sunLight);

            // åˆ›å»ºå¤ªé˜³ç½‘æ ¼
            const sunGeometry = new THREE.SphereGeometry(5, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({
                color: 0xffff00,
                transparent: true,
                opacity: 0.8
            });
            sunMesh = new THREE.Mesh(sunGeometry, sunMaterial);
            scene.add(sunMesh);
        }
        
        // æ·»åŠ åŸå¸‚æ ‡è®°
        function addCityMarkers() {
            const markerGeometry = new THREE.SphereGeometry(1, 16, 16);
            const markerMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xff3300,
                transparent: true,
                opacity: 0.8
            });

            // ä¸ºæ¯ä¸ªåŸå¸‚åˆ›å»ºæ ‡è®°
            Object.entries(cityData).forEach(([key, city]) => {
                const marker = new THREE.Mesh(markerGeometry, markerMaterial);
                
                // è®¡ç®—æ ‡è®°ä½ç½®
                const phi = (90 - city.lat) * Math.PI / 180;
                const theta = (city.lon + 180) * Math.PI / 180;
                const radius = 101; // ç•¥å¤§äºåœ°çƒåŠå¾„ï¼Œç¡®ä¿æ ‡è®°åœ¨åœ°çƒè¡¨é¢
                
                marker.position.set(
                    -radius * Math.sin(phi) * Math.cos(theta),
                    radius * Math.cos(phi),
                    radius * Math.sin(phi) * Math.sin(theta)
                );
                
                // æ·»åŠ åŸå¸‚åç§°æ ‡ç­¾
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 64;
                
                // è®¾ç½®æ–‡å­—æ ·å¼
                context.font = 'bold 32px Arial';
                context.fillStyle = 'white';
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText(city.name, canvas.width / 2, canvas.height / 2);
                
                const texture = new THREE.CanvasTexture(canvas);
                const labelMaterial = new THREE.SpriteMaterial({ 
                    map: texture,
                    transparent: true,
                    depthTest: false, // ç¦ç”¨æ·±åº¦æµ‹è¯•
                    depthWrite: false, // ç¦ç”¨æ·±åº¦å†™å…¥
                    blending: THREE.AdditiveBlending // ä½¿ç”¨åŠ æ³•æ··åˆ
                });
                const label = new THREE.Sprite(labelMaterial);
                label.scale.set(20, 5, 1);
                label.position.copy(marker.position);
                label.position.multiplyScalar(1.1); // ç¨å¾®å‘å¤–åç§»
                label.renderOrder = 999; // ç¡®ä¿æ ‡ç­¾å§‹ç»ˆåœ¨æœ€ä¸Šå±‚
                
                // å°†æ ‡è®°å’Œæ ‡ç­¾æ·»åŠ åˆ°åœ°çƒ
                earth.add(marker);
                earth.add(label);
                
                // å­˜å‚¨æ ‡è®°å¼•ç”¨
                city.marker = marker;
                city.label = label;
            });
        }
        
        // åˆ›å»ºæ ‡è®°
        function createMarker() {
            const markerGeometry = new THREE.SphereGeometry(2, 16, 16);
            const markerMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xff3300,
                transparent: true,
                opacity: 0.9
            });
            
            marker = new THREE.Mesh(markerGeometry, markerMaterial);
            if (earth) {  // ç¡®ä¿earthå­˜åœ¨
                earth.add(marker);
            }
            marker.visible = false;
            
            // åˆ›å»ºæ ‡è®°å…‰æ™•
            const haloGeometry = new THREE.RingGeometry(2.5, 5, 32);
            const haloMaterial = new THREE.MeshBasicMaterial({
                color: 0xff6600,
                transparent: true,
                opacity: 0.6,
                side: THREE.DoubleSide
            });
            
            const halo = new THREE.Mesh(haloGeometry, haloMaterial);
            marker.add(halo);
            halo.rotation.x = Math.PI / 2;
        }
        
        // æ”¾ç½®æ ‡è®°
        function placeMarker(lat, lon) {
            const phi = (90 - lat) * Math.PI / 180;
            const theta = (lon + 180) * Math.PI / 180;
            
            const radius = 101;
            
            marker.position.x = -radius * Math.sin(phi) * Math.cos(theta);
            marker.position.y = radius * Math.cos(phi);
            marker.position.z = radius * Math.sin(phi) * Math.sin(theta);
            
            marker.visible = true;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            marker.scale.set(0, 0, 0);
            new TWEEN.Tween(marker.scale)
                .to({ x: 1, y: 1, z: 1 }, 800)
                .easing(TWEEN.Easing.Elastic.Out)
                .start();
        }
        
        // é£å‘æŒ‡å®šåŸå¸‚
        function viewCity(cityKey) {
            const city = cityData[cityKey];
            if (!city) return;
            
            // é«˜äº®æ˜¾ç¤ºé€‰ä¸­çš„åŸå¸‚æ ‡è®°
            Object.values(cityData).forEach(c => {
                if (c.marker) {
                    c.marker.material.color.setHex(0xff3300);
                    c.marker.material.opacity = 0.8;
                    if (c.label) c.label.visible = true;
                }
            });
            
            if (city.marker) {
                city.marker.material.color.setHex(0x00ff00);
                city.marker.material.opacity = 1;
                if (city.label) city.label.visible = true;
            }
            
            // æ›´æ–°ä¿¡æ¯é¢æ¿
            document.getElementById('info-city').textContent = city.name;
            document.getElementById('info-country').textContent = city.country;
            document.getElementById('info-population').textContent = city.population;
            document.getElementById('info-elevation').textContent = city.elevation;
            document.getElementById('info-temp').textContent = city.temp;
            document.getElementById('info-weather').textContent = city.weather;
            document.getElementById('info-humidity').textContent = city.humidity;
            document.getElementById('info-wind').textContent = city.wind;
            
            // è®¡ç®—å½“åœ°æ—¶é—´
            const now = new Date();
            const localTime = new Date(now.getTime() + (city.lon / 15) * 60 * 60 * 1000);
            const hours = localTime.getHours().toString().padStart(2, '0');
            const minutes = localTime.getMinutes().toString().padStart(2, '0');
            document.getElementById('info-time').textContent = `${hours}:${minutes}`;
            
            // æ˜¾ç¤ºä¿¡æ¯é¢æ¿
            document.getElementById('info-panel').classList.remove('hidden');
            
            // è®¡ç®—ç›®æ ‡ä½ç½®
            const phi = (90 - city.lat) * Math.PI / 180;
            const theta = (city.lon + 180) * Math.PI / 180;
            const radius = 200;
            
            const targetPosition = new THREE.Vector3(
                -radius * Math.sin(phi) * Math.cos(theta),
                radius * Math.cos(phi),
                radius * Math.sin(phi) * Math.sin(theta)
            );
            
            // åˆ›å»ºåŠ¨ç”»
            new TWEEN.Tween(camera.position)
                .to(targetPosition, 3000)
                .easing(TWEEN.Easing.Exponential.Out)
                .start();
            
            // ä¿æŒæ§åˆ¶å™¨ç›®æ ‡ç‚¹åœ¨åœ°çƒä¸­å¿ƒ
            controls.target.set(0, 0, 0);
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æœç´¢æŒ‰é’®
            document.getElementById('search-btn').addEventListener('click', () => {
                const input = document.getElementById('search-input').value.toLowerCase();
                
                if (input === 'tokyo' || input === 'ä¸œäº¬') {
                    viewCity('tokyo');
                } else if (input === 'paris' || input === 'å·´é»') {
                    viewCity('paris');
                } else if (input === 'new york' || input === 'çº½çº¦') {
                    viewCity('newyork');
                } else if (input === 'sydney' || input === 'æ‚‰å°¼') {
                    viewCity('sydney');
                } else if (input === 'beijing' || input === 'åŒ—äº¬') {
                    viewCity('beijing');
                } else if (input === 'london' || input === 'ä¼¦æ•¦') {
                    viewCity('london');
                } else if (input === 'shanghai' || input === 'ä¸Šæµ·') {
                    viewCity('shanghai');
                } else if (input === 'dubai' || input === 'è¿ªæ‹œ') {
                    viewCity('dubai');
                } else {
                    // éšæœºä½ç½®
                    const cities = Object.keys(cityData);
                    const randomCity = cities[Math.floor(Math.random() * cities.length)];
                    viewCity(randomCity);
                }
            });
            
            // æ§åˆ¶æŒ‰é’®
            document.getElementById('reset-view').addEventListener('click', () => {
                camera.position.set(0, 0, 300);
                controls.target.set(0, 0, 0);
                // é‡ç½®æ‰€æœ‰æ ‡è®°
                Object.values(cityData).forEach(city => {
                    if (city.marker) {
                        city.marker.material.color.setHex(0xff3300);
                        city.marker.material.opacity = 0.8;
                        if (city.label) city.label.visible = true;
                    }
                });
                document.getElementById('info-panel').classList.add('hidden');
            });
            
            document.getElementById('toggle-atmosphere').addEventListener('click', () => {
                atmosphereEnabled = !atmosphereEnabled;
                atmosphere.visible = atmosphereEnabled;
            });
            
            document.getElementById('toggle-lights').addEventListener('click', () => {
                cityLightsEnabled = !cityLightsEnabled;
                earth.material.emissiveIntensity = cityLightsEnabled ? 0.5 : 0.0;
            });
            
            document.getElementById('toggle-rotation').addEventListener('click', () => {
                earthRotationEnabled = !earthRotationEnabled;
            });
            
            // æ·»åŠ æ˜¼å¤œå¾ªç¯æ§åˆ¶
            document.getElementById('toggle-daynight').addEventListener('click', () => {
                dayNightCycle = !dayNightCycle;
                if (!dayNightCycle) {
                    // é‡ç½®å¤ªé˜³ä½ç½®åˆ°é»˜è®¤ä½ç½®
                    sunLight.position.set(300, 0, 0);
                    if (sunMesh) {
                        sunMesh.position.copy(sunLight.position);
                    }
                    earth.material.emissiveIntensity = 0.0;
                }
            });
            
            // å…³é—­ä¿¡æ¯é¢æ¿
            document.getElementById('close-info').addEventListener('click', () => {
                document.getElementById('info-panel').classList.add('hidden');
            });
            
            // åœ°ç‚¹é€‰æ‹© - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
            document.querySelector('.location-list').addEventListener('click', (event) => {
                const locationItem = event.target.closest('.location-item');
                if (locationItem) {
                    const location = locationItem.getAttribute('data-location');
                    if (location) {
                        viewCity(location);
                    }
                }
            });
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            // å¤„ç†æœç´¢è¾“å…¥å›è½¦é”®
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('search-btn').click();
                }
            });
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            
            // åœ°çƒè‡ªè½¬
            if (earthRotationEnabled) {
                earth.rotation.y += 0.001;
                cloudLayer.rotation.y += 0.0015;
            }
            
            // æ˜¼å¤œå¾ªç¯
            if (dayNightCycle) {
                // æ›´æ–°å¤ªé˜³è§’åº¦
                sunAngle += dayNightSpeed;
                if (sunAngle > Math.PI * 2) sunAngle -= Math.PI * 2;

                // è®¡ç®—å¤ªé˜³ä½ç½® - åœ¨èµ¤é“å¹³é¢ä¸Šæ—‹è½¬
                const radius = 300;
                const sunX = Math.cos(sunAngle) * radius;
                const sunZ = Math.sin(sunAngle) * radius;
                
                // æ›´æ–°å¤ªé˜³ä½ç½®
                sunLight.position.set(sunX, 0, sunZ);
                if (sunMesh) {
                    sunMesh.position.copy(sunLight.position);
                }

                // æ›´æ–°åœ°çƒç€è‰²å™¨
                if (earth.material.uniforms) {
                    earth.material.uniforms.sunPosition.value.copy(sunLight.position);
                }

                // æ›´æ–°äº‘å±‚ç€è‰²å™¨
                if (cloudLayer.material.uniforms) {
                    cloudLayer.material.uniforms.sunPosition.value.copy(sunLight.position);
                }

                // æ›´æ–°å¤§æ°”å±‚ç€è‰²å™¨
                if (atmosphere && atmosphere.material.uniforms) {
                    atmosphere.material.uniforms.sunPosition.value.copy(sunLight.position);
                }
            }
            
            // æ›´æ–°æ˜Ÿæ˜Ÿ
            if (stars) {
                stars.forEach(starLayer => {
                    starLayer.rotation.y += starLayer.userData.rotationSpeed;
                    
                    const sizes = starLayer.geometry.attributes.size.array;
                    const speeds = starLayer.geometry.attributes.speed.array;
                    const phases = starLayer.geometry.attributes.phase.array;
                    const initialSizes = starLayer.userData.initialSizes;
                    
                    for (let i = 0; i < sizes.length; i++) {
                        const time = Date.now() * 0.001 * speeds[i] + phases[i];
                        const flicker = Math.sin(time) * 0.2 + Math.sin(time * 2) * 0.1;
                        sizes[i] = initialSizes[i] * (0.8 + flicker);
                    }
                    
                    starLayer.geometry.attributes.size.needsUpdate = true;
                });
            }
            
            // æ›´æ–°æ§åˆ¶å™¨
            controls.update();
            
            // æ¸²æŸ“åœºæ™¯
            renderer.render(scene, camera);
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            updateTimeDisplay();
        }
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('time-display').textContent = 
                `ä¸–ç•Œæ—¶: ${hours}:${minutes}`;
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            init();
            // ç¡®ä¿äº‹ä»¶ç›‘å¬å™¨åœ¨DOMåŠ è½½å®Œæˆåè®¾ç½®
            setupEventListeners();
        });
        
        // æ·»åŠ TWEEN.js
        const TWEEN = (function() {
            // ç®€åŒ–çš„TWEENå®ç°
            return {
                Tween: function(object) {
                    this._object = object;
                    this._valuesStart = {};
                    this._duration = 1000;
                    this._easingFunction = TWEEN.Easing.Linear.None;
                    
                    this.to = function(properties, duration) {
                        this._valuesEnd = properties;
                        if (duration !== undefined) this._duration = duration;
                        return this;
                    };
                    
                    this.easing = function(easing) {
                        this._easingFunction = easing;
                        return this;
                    };
                    
                    this.start = function() {
                        this._startTime = Date.now();
                        for (let property in this._valuesEnd) {
                            this._valuesStart[property] = this._object[property];
                        }
                        TWEEN.add(this);
                        return this;
                    };
                    
                    this.update = function() {
                        const time = Date.now();
                        const elapsed = time - this._startTime;
                        
                        if (elapsed >= this._duration) {
                            for (let property in this._valuesEnd) {
                                this._object[property] = this._valuesEnd[property];
                            }
                            TWEEN.remove(this);
                            return false;
                        }
                        
                        const progress = this._easingFunction(elapsed / this._duration);
                        for (let property in this._valuesEnd) {
                            const start = this._valuesStart[property];
                            const end = this._valuesEnd[property];
                            this._object[property] = start + (end - start) * progress;
                        }
                        
                        return true;
                    };
                },
                
                _tweens: [],
                
                add: function(tween) {
                    this._tweens.push(tween);
                },
                
                remove: function(tween) {
                    const index = this._tweens.indexOf(tween);
                    if (index !== -1) this._tweens.splice(index, 1);
                },
                
                update: function() {
                    for (let i = this._tweens.length - 1; i >= 0; i--) {
                        if (!this._tweens[i].update()) {
                            this._tweens.splice(i, 1);
                        }
                    }
                },
                
                Easing: {
                    Linear: {
                        None: function(k) { return k; }
                    },
                    Exponential: {
                        Out: function(k) {
                            return k === 1 ? 1 : 1 - Math.pow(2, -10 * k);
                        }
                    },
                    Elastic: {
                        Out: function(k) {
                            if (k === 0) return 0;
                            if (k === 1) return 1;
                            return Math.pow(2, -10 * k) * Math.sin((k - 0.1) * 5 * Math.PI) + 1;
                        }
                    }
                }
            };
        })();
    </script>
</body>
</html>
